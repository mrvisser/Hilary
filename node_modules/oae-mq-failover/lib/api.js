
var log = require('oae-logger').logger('oae-mq-failover');
var MQ = require('oae-util/lib/mq');

var receiveInvalid = 0;
var receiveInaccurate = 0;
var submitError = 0;

var sendWhileDown = 0;
var index = 0;
var count = 0;

var begin = module.exports.begin = function() {
    //_ping();
    _sendWhileDown();
};

//////////////////////////
// SEND WHILE DOWN TEST //
//////////////////////////

var _sendWhileDown = function() {
    process.nextTick(function() {
        var data = {'value': ++sendWhileDown};
        log().info('Ping: %s', data.value);
        MQ.submit('oae-mq-failover/send-while-down', data, function(failed, retryAttempts) {
            // setTimeout(_sendWhileDown, 500);
        });

        setTimeout(_sendWhileDown, 500);
    });
};

MQ.bind('oae-mq-failover/send-while-down', function(data, callback) {
    log().info('Received a pong: %s', data.value);
    callback();
});

///////////////
// PING TEST //
///////////////

var _ping = function(callback) {
    callback = callback || function(){};

    // Send a task, recording the value (index) and task state
    process.nextTick(function() {
        index++;

        MQ.submit('oae-mq-failover/ping', {'value': index}, function(failed, retryAttempts) {
            if (failed) {
                log().error('Error submitting after %s attempts', retryAttempts);
                submitError++;
            }

            count++;
            callback();
        });
    });
};

MQ.bind('oae-mq-failover/ping', function(data, callback) {
    count--;

    if (index % 250 === 0) {
        log().info({
            'receiveInvalid': receiveInvalid,
            'receiveInaccurate': receiveInaccurate,
            'index': index,
            'count': count
        }, 'Test status');
    }

    if (!data) {
        receiveInvalid++;
    } else if (!data.value) {
        receiveInvalid++;
    } else if (data.value !== index) {
        receiveInaccurate++;
    }

    log().info('Received: %s', data.value);

    _ping(callback);

}, {'subscribe': {'prefetchCount': 1}});